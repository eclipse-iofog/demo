#
# Test Suite of Smoke tests for our Demo docker environment
#
# This suite is built using 'pyresttest' (https://github.com/svanoort/pyresttest)
#
---
- config:
    - testset: "Testing connection to iofog-controller via REST API"

- test:
    - name: "Non Auth Connection"
    - group: "Controller"
    - url: "/api/v3/iofog"
    - expected_status: [404]

- test:
      - name: "Get Status"
      - group: "Controller"
      - url: "/api/v3/status"
      - headers: {'Content-Type': 'application/json'}
      - method: 'GET'
      - expected_status: [200]

- test:
      - name: "Get Email Activation"
      - group: "Controller"
      - url: "/api/v3/email-activation"
      - headers: {'Content-Type': 'application/json'}
      - method: 'GET'
      - expected_status: [200]

- test:
      - name: "Get Fog Types"
      - group: "Controller"
      - url: "/api/v3/fog-types"
      - headers: {'Content-Type': 'application/json'}
      - method: 'GET'
      - expected_status: [200]

- test:
      - name: "Sign up"
      - group: "User"
      - url: "/api/v3/user/signup"
      - headers: {'Content-Type': 'application/json'}
      - body: '{"firstName":"Serge","lastName":"Radinovich","email":"serge@edgeworx.io","password":"123pwer89iu23409i"}'
      - method: "POST"
      - expected_status: [201]

- test:
      - name: "Login"
      - group: "User"
      - url: "/api/v3/user/login"
      - headers: {'Content-Type': 'application/json'}
      - body: '{"email":"serge@edgeworx.io","password":"123pwer89iu23409i"}'
      - method: "POST"
      - expected_status: [200]
      - extract_binds:
        - 'accessToken': {'jsonpath_mini': 'accessToken'}

- test:
      - name: "Get Profile"
      - group: "User"
      - url: "/api/v3/user/profile"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "GET"
      - expected_status: [200]

- test:
      - name: "Get Flow"
      - group: "Flow"
      - url: "/api/v3/flow"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "GET"
      - expected_status: [200]

- test:
      - name: "Get Iofog Node List"
      - group: "Iofog"
      - url: "/api/v3/iofog-list"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "GET"
      - expected_status: [200]

# TODO: Need agent details first
#- test:
#      - name: "Create a new ioFog node"
#      - group: "Iofog"
#      - url: "/api/v3/iofog"
#      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
#      - body: '{ "fogType": { "id": 1, "name": "Standard Linux (x86)", "image": "iointegrator1.png", "description": "A standard Linux server of at least moderate processing power and capacity. Compatible with common Linux types such as Ubuntu, Red Hat, and CentOS." } }'
#      - method: "POST"
#      - expected_status: [200]
#
# TODO: Need to register agent first
#- test:
#      - name: "Get Iofog Node Info"
#      - group: "Iofog"
#      - url: {'template':"/api/v3/iofog/$node_id"}
#      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
#      - method: "GET"
#      - expected_status: [200]

- test:
      - name: "Create Agent Node"
      - group: "Iofog"
      - url: "/api/v3/iofog"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - body: '{"name":"agent-smith","fogType":0}'
      - method: "POST"
      - extract_binds:
        - 'uuid': {'jsonpath_mini': 'uuid'}
      - expected_status: [201]

- test:
      - name: "Provision Key for Agent"
      - group: "Iofog"
      - url: {'template':"/api/v3/iofog/$uuid/provisioning-key"}
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "GET"
      - extract_binds:
        - 'key': {'jsonpath_mini': 'key'}
      - expected_status: [201]

- test:
      - name: "Get Microservices Catalog"
      - group: "Catalog"
      - url: "/api/v3/catalog/microservices"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "GET"
      - expected_status: [200]

- test:
      - name: "Get Registries"
      - group: "Registries"
      - url: "/api/v3/registries"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "GET"
      - expected_status: [200]

- test:
      - name: "Log out"
      - group: "User"
      - url: "/api/v3/user/logout"
      - headers: {template:{'Content-Type': 'application/json', 'Authorization': "$accessToken"}}
      - method: "POST"
      - expected_status: [204]
